<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Center</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-center flex-grow-1">Admin Center</h1>
    <a href="/" class="btn btn-secondary ms-3">Home</a>
  </div>

  <div class="mb-3">
    <button class="btn btn-primary me-2" onclick="loadTable('topten')">View Top Ten</button>
    <button class="btn btn-outline-dark me-2" onclick="loadTable('divisions')">View Divisions</button>
    <button class="btn btn-outline-dark me-2" onclick="loadTable('belt_ranks')">View Belt Ranks</button>
    <button class="btn btn-outline-dark me-2" onclick="loadTable('schools')">View Schools</button>
    <button class="btn btn-outline-dark me-2" onclick="loadTable('events')">View Events</button>
    <button class="btn btn-outline-dark me-2" onclick="loadTable('tournaments')">View Tournaments</button>
  </div>

  <div id="tableContainer" class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead id="tableHead"></thead>
      <tbody id="tableBody">
        <tr><td class="text-center">Select a table to view data</td></tr>
      </tbody>
    </table>
  </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm"></form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="editForm" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let currentType = null;
    let currentRowId = null;

    async function loadTable(type) {
      currentType = type;
      let url = `/api/${type}`;
      if (type === "topten") url = "/api/topten";
      if (type === "tournaments") url = "/api/all_tourn";

      const res = await fetch(url);
      const data = await res.json();

      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td class="text-center">No data found</td></tr>`;
        return;
      }

      // Add an Edit column
      const headers = Object.keys(data[0]);
      const headerRow = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}<th>Actions</th></tr>`;
      tableHead.innerHTML = headerRow;
          //Remove comment when Top Ten can be edited
<!--      data.forEach(row => {-->
<!--        const rowHtml = `<tr>-->
<!--          ${headers.map(h => `<td>${row[h] ?? ""}</td>`).join("")}-->
<!--          <td><button class="btn btn-sm btn-warning" onclick='openEdit(${JSON.stringify(row)})'>Edit</button></td>-->
<!--        </tr>`;-->
<!--        tableBody.innerHTML += rowHtml;-->
<!--      });-->

          //Temp until fixed Top Ten Query
          data.forEach(row => {
          const rowHtml = `<tr>
            ${headers.map(h => `<td>${row[h] ?? ""}</td>`).join("")}
            <td>${
              currentType === "topten"
                ? "" // no edit button for Top Ten
                : `<button class="btn btn-sm btn-warning" onclick='openEdit(${JSON.stringify(row)})'>Edit</button>`
            }</td>
          </tr>`;
          tableBody.innerHTML += rowHtml;
        });
    }

    function openEdit(row) {
      currentRowId = row.id;
      const form = document.getElementById("editForm");
      form.innerHTML = "";

      for (const [key, value] of Object.entries(row)) {
        if (key === "id") continue; // donâ€™t edit PK
        form.innerHTML += `
          <div class="mb-3">
            <label class="form-label">${key}</label>
            <input type="text" class="form-control" name="${key}" value="${value ?? ""}">
          </div>
        `;
      }

      const modal = new bootstrap.Modal(document.getElementById("editModal"));
      modal.show();
    }

    document.getElementById("editForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);

      const res = await fetch(`/api/${currentType}/${currentRowId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        alert("Updated successfully!");
        loadTable(currentType);
        bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      } else {
        alert("Error updating entry.");
      }
    });
  </script>

</body>
</html>
