<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-center flex-grow-1">Tournament Results</h1>
    <a href="/" class="btn btn-secondary ms-3">Home</a>
  </div>

  <!-- Filter Form -->
  <form id="filterForm" class="row g-3 mb-4">
    <div class="col-md-2">
      <label class="form-label">Division</label>
      <select name="division" class="form-select">
        <option value="">All</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Event</label>
      <select name="event_name" class="form-select">
        <option value="">All</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">School</label>
      <select name="school" class="form-select">
        <option value="">All</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Belt Rank</label>
      <select name="rank" class="form-select">
        <option value="">All</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Search by First Name</label>
      <input type="text" name="fname" class="form-control" placeholder="First name">
    </div>
        <div class="col-md-3">
      <label class="form-label">Search by Last Name</label>
      <input type="text" name="lname" class="form-control" placeholder="Last name">
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>
        <div class="col-md-1 d-flex align-items-end">
      <button class="btn btn-primary w-100" onclick="">Update Rankings</button>
    </div>
  </form>

  <!-- Results Table -->
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>First</th>
        <th>Last</th>
        <th>Division</th>
        <th>Belt Rank</th>
        <th>School</th>
        <th>Age</th>
        <th>Event</th>
        <th>Top Ten Rank</th>
        <th>Tournament</th>
        <th>Tournament Points</th>
        <th>Total Points</th>
      </tr>
    </thead>
    <tbody id="resultsTable">
      <tr><td colspan="12" class="text-center">Loading...</td></tr>
    </tbody>
  </table>

<script>
  // Map form field names to API endpoints + fallback keys
  const filterConfig = {
    division: { endpoint: "/api/divisions", keys: ["division", "name"] },
    event_name: { endpoint: "/api/events", keys: ["event", "name"] },
    school: { endpoint: "/api/schools", keys: ["school", "name"] },
    rank: { endpoint: "/api/belt_ranks", keys: ["belt_rank", "rank", "name"] }
  };

  // Helper to safely get first matching key
  function getValue(obj, keys) {
    for (const key of keys) {
      if (obj[key] !== undefined && obj[key] !== null) {
        return obj[key];
      }
    }
    return "";
  }

  // Load filter dropdown values
  async function loadFilters() {
    for (const [fieldName, { endpoint, keys }] of Object.entries(filterConfig)) {
      const res = await fetch(endpoint);
      const data = await res.json();
      const select = document.querySelector(`select[name="${fieldName}"]`);

      // clear old options except "All"
      select.querySelectorAll("option:not([value=''])").forEach(opt => opt.remove());

      data.forEach(item => {
        const val = getValue(item, keys);
        if (val) {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        }
      });
    }
  }

  // Load results with optional filters
  async function loadResults(query = "") {
    const response = await fetch(`/api/topten${query}`);
    const data = await response.json();
    const tableBody = document.getElementById("resultsTable");
    tableBody.innerHTML = "";

    if (data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="12" class="text-center">No results found</td></tr>`;
      return;
    }

    data.forEach(r => {
      const row = `
        <tr>
          <td>${r.fname ?? ""}</td>
          <td>${r.lname ?? ""}</td>
          <td>${r.division ?? ""}</td>
          <td>${r.belt_rank ?? ""}</td>
          <td>${r.school ?? ""}</td>
          <td>${r.age ?? ""}</td>
          <td>${r.event ?? ""}</td>
          <td>${r.top_ten_rank ?? ""}</td>
          <td>${r.tournament ?? ""}</td>
          <td>${r.tourn_pts ?? ""}</td>
          <td>${r.total_pts ?? ""}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  }

  // Handle filter form submission
  document.getElementById("filterForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const params = new URLSearchParams(new FormData(this)).toString();
    loadResults("?" + params);
  });

  // Initial load
  loadFilters();
  loadResults();
</script>

<script>
  async function updateRankings() {
    try {
      const res = await fetch("/api/update_rankings", {
        method: "GET"
        headers: { "Content-Type": "application/json" }
      });

      if (res.ok) {
        const msg = await res.json();
        alert("Rankings updated successfully!\n" + (msg.message || ""));
      } else {
        alert("Error updating rankings.");
      }
    } catch (err) {
      console.error(err);
      alert("Failed to reach server.");
    }
  }
</script>
</body>
</html>
